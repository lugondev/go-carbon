package gen

import (
	"fmt"

	"github.com/lugondev/go-carbon/internal/codegen"
)

// ProgramGenerator generates program metadata and constants.
type ProgramGenerator struct {
	*Generator
}

// NewProgramGenerator creates a new program generator.
func NewProgramGenerator(gen *Generator) *ProgramGenerator {
	return &ProgramGenerator{Generator: gen}
}

// Generate generates program metadata.
func (g *ProgramGenerator) Generate() error {
	// Generate ProgramID constant
	if err := g.generateProgramID(); err != nil {
		return err
	}

	// Generate program metadata
	g.generateProgramMetadata()

	return nil
}

// generateProgramID generates the ProgramID constant.
func (g *ProgramGenerator) generateProgramID() error {
	if g.IDL.Address == "" {
		return fmt.Errorf("program address is empty")
	}

	stmt, err := GenerateProgramIDConstant(g.IDL.Address)
	if err != nil {
		return fmt.Errorf("failed to generate ProgramID: %w", err)
	}

	g.File.Add(stmt)
	g.File.Line()

	return nil
}

// generateProgramMetadata generates program metadata constants.
func (g *ProgramGenerator) generateProgramMetadata() {
	metadata := g.IDL.Metadata

	// Generate program name constant
	if metadata.Name != "" {
		g.File.Comment("ProgramName is the name of the program.")
		g.File.Const().Id("ProgramName").Op("=").Lit(metadata.Name)
		g.File.Line()
	}

	// Generate program version constant
	if metadata.Version != "" {
		g.File.Comment("ProgramVersion is the version of the program.")
		g.File.Const().Id("ProgramVersion").Op("=").Lit(metadata.Version)
		g.File.Line()
	}

	// Generate program spec constant
	if metadata.Spec != "" {
		g.File.Comment("ProgramSpec is the Anchor spec version.")
		g.File.Const().Id("ProgramSpec").Op("=").Lit(metadata.Spec)
		g.File.Line()
	}

	// Generate program description constant (if present)
	if metadata.Description != "" {
		g.File.Comment("ProgramDescription is the description of the program.")
		g.File.Const().Id("ProgramDescription").Op("=").Lit(metadata.Description)
		g.File.Line()
	}
}

// GenerateProgramFile generates the program.go file.
func GenerateProgramFile(idl *codegen.IDL, packageName, outputDir string) error {
	gen := NewGenerator(idl, packageName)
	progGen := NewProgramGenerator(gen)

	// Add file header comment
	gen.File.Comment("Code generated by go-carbon. DO NOT EDIT.")
	gen.File.Comment(fmt.Sprintf("Package %s contains generated code for the %s Solana program.", packageName, idl.Metadata.Name))
	gen.File.Line()

	// Generate program metadata
	if err := progGen.Generate(); err != nil {
		return err
	}

	// Save to file
	filename := fmt.Sprintf("%s/program.go", outputDir)
	return gen.WriteToFile(filename)
}
